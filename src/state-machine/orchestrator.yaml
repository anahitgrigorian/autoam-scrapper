---
StartAt: 'GetPageCount'
States:
  CheckPagesScrapped:
    Type: Task
    Resource: ${CheckPagesScrapped}
    Next: CheckValueCondition

  CheckValueCondition:
    Type: Choice
    Choices:
      - Variable: "$.result"
        StringEquals: "scrapped"
        Next: ProcessNewListings
      - Variable: "$.result"
        StringEquals: "not_scrapped"
        Next: GetPageCount

  ProcessNewListings:
    Type: Task
    Resource: ${ProcessNewListingsArn}
    End: true

  GetPageCount:
    Type: Task
    Resource: ${GetPageCountArn}
    ResultPath: '$.pages_count'
    Next: 'ProcessPages'

  ProcessPages:
    Type: Map
    ItemsPath: '$.pages_count'
    MaxConcurrency: 10
    Iterator:
      StartAt: 'PageScrapperLambda'
      States:
        PageScrapperLambda:
          Type: 'Task'
          Resource: ${PageScrapperFunctionArn}
          InputPath: '$.iterator.index'
          End: true
    Next: 'SetPagesScrapped'

  SetPagesScrapped:
    Type: Task
    Resource: ${SetPagesScrapped}
    End: true
